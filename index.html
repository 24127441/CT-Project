<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra D·ªØ Li·ªáu Trekking Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        
        /* Thanh ƒëi·ªÅu khi·ªÉn ph√≠a tr√™n */
        #controls { 
            padding: 15px; 
            background: #ffffff; 
            border-bottom: 2px solid #eee; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        #map { flex-grow: 1; z-index: 1; }

        select { 
            padding: 10px; 
            font-size: 16px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            width: 350px; 
            outline: none;
        }

        /* Style cho c√°c Icon tr√™n b·∫£n ƒë·ªì */
        .custom-icon { 
            text-align: center; 
            line-height: 1; 
            transition: transform 0.2s;
        }
        .custom-icon:hover {
            transform: scale(1.2);
            z-index: 1000 !important;
        }
        .emoji-icon {
            font-size: 28px;
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3));
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="controls">
        <label><b>üó∫Ô∏è Ch·ªçn Cung ƒê∆∞·ªùng:</b></label>
        <select id="routeSelect">
            <option value="">-- ƒêang k·∫øt n·ªëi Database... --</option>
        </select>
        <div id="loading" class="loader"></div>
        <span id="statusText" style="color: #666; font-size: 14px;"></span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ============================================================
        // C·∫§U H√åNH K·∫æT N·ªêI (ƒê√£ ƒëi·ªÅn s·∫µn c·ªßa b·∫°n)
        // ============================================================
        const SUPABASE_URL = 'https://qesmaldvlbfznrkrzdhc.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlc21hbGR2bGJmem5ya3J6ZGhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjA3ODEsImV4cCI6MjA3OTI5Njc4MX0.bMDQmD99x7CdFTOfakCkHqQQsWcac5sc4awO6hMXfRQ';

        // Kh·ªüi t·∫°o client (D√πng t√™n 'dbClient' ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
        const dbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================================
        // KH·ªûI T·∫†O B·∫¢N ƒê·ªí
        // ============================================================
        const map = L.map('map').setView([16.0, 108.0], 5); // View to√†n Vi·ªát Nam
        
        // Th√™m l·ªõp n·ªÅn OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Layer Group ƒë·ªÉ qu·∫£n l√Ω c√°c ƒë·ªëi t∆∞·ª£ng v·∫Ω (gi√∫p x√≥a ƒëi v·∫Ω l·∫°i d·ªÖ d√†ng)
        let drawingLayer = L.layerGroup().addTo(map);

        // ============================================================
        // H√ÄM 1: L·∫§Y DANH S√ÅCH CUNG ƒê∆Ø·ªúNG (Dropdown)
        // ============================================================
        async function loadRouteList() {
            const status = document.getElementById('statusText');
            
            // G·ªçi Supabase
            const { data, error } = await dbClient
                .from('routes')
                .select('id, name')
                .order('name');
            
            const select = document.getElementById('routeSelect');
            
            if (error) {
                console.error("L·ªói:", error);
                select.innerHTML = '<option>‚ùå L·ªói k·∫øt n·ªëi Supabase!</option>';
                status.textContent = "Ki·ªÉm tra l·∫°i Key ho·∫∑c RLS Policy.";
                status.style.color = "red";
                return;
            }

            // ƒê·ªï d·ªØ li·ªáu v√†o Select
            select.innerHTML = '<option value="">-- Ch·ªçn m·ªôt cung ƒë∆∞·ªùng ƒë·ªÉ xem --</option>';
            data.forEach(route => {
                const option = document.createElement('option');
                option.value = route.id;
                option.textContent = route.name;
                select.appendChild(option);
            });

            // L·∫Øng nghe s·ª± ki·ªán ch·ªçn
            select.addEventListener('change', (e) => {
                if (e.target.value) loadRouteDetail(e.target.value);
            });
            
            status.textContent = `ƒê√£ t·∫£i xong ${data.length} cung ƒë∆∞·ªùng.`;
        }

        // ============================================================
        // H√ÄM 2: HI·ªÇN TH·ªä CHI TI·∫æT (V·∫Ω ƒë∆∞·ªùng + Icon)
        // ============================================================
        async function loadRouteDetail(routeId) {
            const loader = document.getElementById('loading');
            loader.style.display = 'block';
            drawingLayer.clearLayers(); // X√≥a h√¨nh c≈©

            // 1. L·∫•y d·ªØ li·ªáu ƒë∆∞·ªùng ƒëi (Coordinates)
            const { data: routeData } = await dbClient
                .from('routes')
                .select('name, path_coordinates')
                .eq('id', routeId)
                .single();

            // 2. L·∫•y d·ªØ li·ªáu ƒëi·ªÉm Waypoints (Warnings, Water...)
            const { data: wptData } = await dbClient
                .from('route_waypoints')
                .select('*')
                .eq('route_id', routeId);

            loader.style.display = 'none';

            // --- V·∫º ƒê∆Ø·ªúNG ƒêI ---
            if (routeData && routeData.path_coordinates && routeData.path_coordinates.length > 0) {
                const coords = routeData.path_coordinates;

                // V·∫Ω ƒë∆∞·ªùng Polyline m√†u ƒë·ªè
                const polyline = L.polyline(coords, {
                    color: '#e63946', 
                    weight: 5,
                    opacity: 0.8,
                    lineJoin: 'round'
                }).addTo(drawingLayer);

                // Zoom b·∫£n ƒë·ªì v·ª´a kh√≠t ƒë∆∞·ªùng ƒëi
                map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

                // Th√™m Icon ƒêI·ªÇM XU·∫§T PH√ÅT (ƒê·∫ßu m·∫£ng)
                createMarker(coords[0], 'üü¢', 'üèÅ ƒêi·ªÉm Xu·∫•t Ph√°t', 'B·∫Øt ƒë·∫ßu h√†nh tr√¨nh t·∫°i ƒë√¢y');

                // Th√™m Icon ƒêI·ªÇM K·∫æT TH√öC (Cu·ªëi m·∫£ng)
                createMarker(coords[coords.length - 1], 'üèÅ', 'üèÜ ƒêi·ªÉm K·∫øt Th√∫c', 'Ho√†n th√†nh ch·∫∑ng ƒë∆∞·ªùng');
            }

            // --- V·∫º C√ÅC ƒêI·ªÇM WAYPOINTS ---
            if (wptData) {
                wptData.forEach(pt => {
                    let iconEmoji = 'üìç';
                    let typeName = 'ƒêi·ªÉm m·ªëc';

                    // Ch·ªçn Emoji d·ª±a tr√™n lo·∫°i ƒëi·ªÉm
                    switch(pt.type) {
                        case 'summit':    iconEmoji = 'üö©'; typeName = 'ƒê·ªânh N√∫i'; break;
                        case 'danger':    iconEmoji = '‚ö†Ô∏è'; typeName = 'Nguy Hi·ªÉm'; break;
                        case 'water':     iconEmoji = 'üíß'; typeName = 'Ngu·ªìn N∆∞·ªõc'; break;
                        case 'campsite':  iconEmoji = '‚õ∫'; typeName = 'B√£i Tr·∫°i'; break;
                        case 'scenic':    iconEmoji = 'üì∑'; typeName = 'Check-in'; break;
                        case 'checkpoint': iconEmoji = 'üõë'; typeName = 'Tr·∫°m/M·ªëc'; break;
                    }

                    createMarker([pt.latitude, pt.longitude], iconEmoji, pt.name, pt.description);
                });
            }
        }

        // H√†m ph·ª• tr·ª£ t·∫°o Marker nhanh
        function createMarker(latlng, emoji, title, desc) {
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="emoji-icon">${emoji}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -30]
                })
            }).addTo(drawingLayer);

            marker.bindPopup(`
                <div style="min-width: 200px">
                    <h3 style="margin: 0 0 5px 0; color: #2c3e50;">${title}</h3>
                    <p style="margin: 0; color: #555; font-size: 13px;">${desc || ''}</p>
                </div>
            `);
        }

        // Ch·∫°y ngay khi m·ªü web
        loadRouteList();

    </script>
</body>
</html>